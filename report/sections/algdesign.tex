\chapter{Algorithm design}
\todo{ROUGH SKETCH not done yet}

In this chapter the two stereo vision algorithms, Efficient Edge Preserving Stereo Matching (EEPSM) and Fast Cost-Volume Matching (FCV), is described. Lastly, a simulation of each algorithm is created and the results of these simulations are compared and from this, an algorithm is chosen.

\section{Efficient Edge Preserving Stereo Matching:}
This algorithm works in three steps. The first step is calculating a cost for each pixel and disparity. This cost is a combination of the sum of absolute differences and hamming distance of the census transform around each pixel.
\begin{flalign}
&& C^{SAD}_d(x,y) &=  \sum^3_{i=1}| I_{left}(x,y,i) - I_{right}(x+d,y,i) |  &&\\
&& C^{CENSUS}_d(x,y) &= Ham(CT_{left}(x,y),CT_{right}(x+d,y)) && \\
&& C_d(x,y) &= \alpha \cdot C_d^{SAD} (x,y) + (1-\alpha)\cdot C^{CENSUS}_d (x,y) &&
\end{flalign}
where $d$ is the disparity estimate, $I_{left}$ is the left image, $I_{right}$ is the right image, $i$ is the color (rgb), $Ham(x_1,x_2)$ is the hamming distance between $x_1$ and $x_2$, and $CT_{left}$ and $CT_{right}$ is the census transform around the specified pixel\\
then a permeability weight is calculated. Permeability is known from biomedicine and describes the ability to transfer through a membrane. The permeability weight is inspired by this and describes how well the color transfers from one pixel to another pixel. 
\begin{flalign}
  && \mu(x,y) &= \min(e^{\frac{-\Delta R}{\sigma}},e^{\frac{-\Delta G}{\sigma}},e^{\frac{-\Delta B}{\sigma}}) &&\\
  && \mu_{tb}(x,y) &= \min(e^{\frac{-(R(x,y)-R(x,y-1))}{\sigma}},e^{\frac{-(G(x,y)-G(x,y-1))}{\sigma}},e^{\frac{-(B(x,y)-B(x,y-1))}{\sigma}}) &&
\end{flalign}
lastly, the cost is aggregated resulting in a combined cost for each pixel at each disparity. The cost from equation ?? is first aggregated horizontally using permeability weights from equation ??. Then the result from horizontal aggregation is aggregated vertically also using the permeability weight. 

\begin{flalign}
  && C_d^{lr}(x,y) &= C_d(x,y) + \mu_{lr}(x,y) \cdot C_d(x-1,y) &&\\
  && C_d^{lr}(x,y) &= C_d(x,y) + \sum_{i=1}^{x-1} \left(C_d(x-i,y) \cdot \Pi_{j=i}^{i} \mu_{lr}(x-1,y) \right) &&
\end{flalign}

With a cost at each pixel at each disparity estimate, the disparity map can be generated by minimization along the disparity estimates.

\section{Fast Cost-Volume Matching:}
This algorithm starts by calculating a cost for each pixel at each disparity estimate. This cost consists of the sum of absolute differences and differences in the gradient.

\begin{flalign}
 && C^{SAD}_{d} (x,y) &= \sum^3_{i=1}| I_{left}(x,y,i) - I_{right}(x+d,y,i) |  &&\\
  && C^{Grad}_{d} (x,y) &= \nabla_x I_{left}^{g} (x,y) - \nabla_x I_{right}^{g} (x,y) &&\\
  && C_{d} (x,y) &= \alpha \cdot C^{SAD}_{d} (x,y) + (1 - \alpha) \cdot C^{Grad}_{d} (x,y) &&
\end{flalign}  

These cost values are then filtered using a Guided Image Filter. The guided image filter is a filter uses a reference image to generate the weights. The guided image filter is described further in section \ref{sec:guidedif}

\begin{flalign}
  && C'_d (x,y) &= \sum_j W_i,j(I)C_d(x,y) &&
\end{flalign}

The correct disparity for each pixel can then be found by minimizing along the disparity estimates as seen in equation \ref{eq:fcvmin}.

\begin{flalign} \label{eq:fcvmin}
  && f(x,y) &= \arg \min_{d \in [0,d_{max}]} C'_d(x,y)&&
\end{flalign}

\subsection{Guided image filter} \label{sec:guidedif}
The guided image filter uses a image as a reference for weighting the input. The output from the filter is seen in equation  

\begin{flalign}
  && q_i &= \sum_j W_{i,j}(I)p_j &&\\
  && q_i &= a_k I_i + b_k \quad, \forall i \in \omega_k &&
\end{flalign}
where:
\begin{flalign}
  && a_k &= \dfrac{\frac{1}{|\omega|} \sum_{i \in \omega_k} I_i p_i - \mu_k \bar{p}_k}{\sigma^2_k + \epsilon} &&\\
  && b_k &= \bar{p}_k - a_k \mu_k &&  
\end{flalign}


\newpage
\section{Fast Cost volume}
Fast Cost Volume (FCV) starts by calculating the cost for a 

\begin{flalign}
  C^{SAD}_{i,d} &= \sum^{3}_{k=1} || I^{left}_{i} - I^{right}_{i-d} ||\\
  C^{Grad}_{i,d} &= \nabla_x Ig_i - \nabla_x lg_{i-d} \\
  C^{Total}_{i,d} &= \alpha \cdot C^{SAD}_{i,d} + (1 - \alpha) \cdot C^{Grad}_{i,d}
\end{flalign}  
{\footnotesize Where $I$ is the color image, $Ig$ is a grayscale image}



\subsection{Guided Image filtering}
\textbf{Input:} \\
filtering input image: $p$\\
guidance image: $I$\\
radius: $r$\\
epsilon: $\epsilon$\\
\textbf{Output:} \\
filtering output: $q$\\
\textbf{Steps:}
\begin{enumerate}
  \item $\mu_I = f_{mean}(I)$ \\
           $\mu_p = f_{mean}(p)$ \\
           $\rho_{II} = f_{mean}(I \cdot I)$ \\
           $\rho_{Ip} = f_{mean}(I \cdot p)$
  \item $\sigma_I = \rho_{II} - \mu_I \cdot \mu_I$\\
           $cov_{Ip} = \rho_{Ip} - \mu_I \cdot \mu_p$
  \item $a = cov_{Ip}/(\sigma_I + epsilon)$\\
           $b = \mu_p - a \cdot \mu_I $
  \item $\mu_a = f_{mean}(a)$\\
           $\mu_b = f_{mean}(b)$
  \item $q = \mu_a \cdot I + \mu_b$
  
\end{enumerate}